<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Ventas - Tienda</title>
  <!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">-->
  <style>
    /*body { margin: 0; font-family: Arial, sans-serif; }
    header {
      background: #333;
      padding: 10px 20px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header .logo {
      margin: 0;
      font-size: 20px;
      color: #fff;
    }
    nav a {
      color: #fff;
      text-decoration: none;
      margin: 0 10px;
      font-size: 16px;
    }
    nav a:hover {
      text-decoration: underline;
    }*/
  </style>
</head>
<body class="bg-light">

  <header>
    <h1 class="logo">Gestión Inventario</h1>
    <nav>
      <a href="../index.html">Inicio</a>
      <a href="./usuarios.html">Usuarios</a>
      <a href="./proveedores.html">Proveedores</a>
      <a href="./productos.html">Productos</a>
      <a href="./categorias.html">categorias</a>
      <a href="./ventas.html">Ventas</a>
      <a href="./compras.html">Compras</a>
    <!--  <a href="">Ventas</a> -->
    </nav>
  </header>

<div class="container mt-5">
  <h1 class="mb-4">Gestión de Ventas</h1>

  <button class="btn btn-primary mb-3" onclick="abrirModalAgregar()">Agregar Venta</button>

  <table class="table table-striped" id="tablaVentas">
    <thead class="table-dark">
      <tr>
        <th>ID Venta</th>
        <th>Usuario</th>
        <th>Fecha</th>
        <th>Total</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal Agregar/Editar Venta -->
<div class="modal fade" id="modalVenta" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title" id="tituloModal">Agregar Venta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="id_venta">
        <div class="mb-3">
          <label>ID Usuario</label>
          <input type="number" id="id_usuario" class="form-control">
        </div>

        <h5>Productos</h5>
        <table class="table table-bordered" id="tablaProductos">
          <thead class="table-light">
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Subtotal</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button type="button" class="btn btn-success mb-3" id="btnAgregarProducto">Agregar Producto</button>

        <div class="mb-3">
          <label>Total</label>
          <input type="text" id="total" class="form-control" readonly>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" id="btnGuardar">Guardar</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const apiUrl = "/ventas";

let ventaEditando = null;

// Lista de productos disponibles
const productosDisponibles = [
  {id:1, nombre:'Intel Core i7', precio:350},
  {id:2, nombre:'AMD Ryzen 5', precio:300},
  {id:3, nombre:'Kingston RAM 16GB', precio:90},
  {id:4, nombre:'Corsair RAM 32GB', precio:180},
  {id:5, nombre:'NVIDIA RTX 3060', precio:450},
  {id:6, nombre:'Samsung SSD 1TB', precio:120},
  {id:7, nombre:'Logitech Mouse G502', precio:50}
];

// --- Funciones auxiliares ---
function actualizarSubtotal(row){
  const cantidad = parseFloat(row.querySelector('.cantidad').value) || 0;
  const precio = parseFloat(row.querySelector('.precio').value) || 0;
  row.querySelector('.subtotal').textContent = (cantidad*precio).toFixed(2);
  actualizarTotal();
}

function actualizarTotal(){
  let total = 0;
  document.querySelectorAll('#tablaProductos tbody tr').forEach(row=>{
    total += parseFloat(row.querySelector('.subtotal').textContent) || 0;
  });
  document.getElementById('total').value = total.toFixed(2);
}

function agregarFila(producto={}){
  const row = document.createElement('tr');
  row.innerHTML = `
    <td>
      <select class="form-select producto" required>
        <option value="">Seleccione</option>
        ${productosDisponibles.map(p=>`<option value="${p.id}" ${p.id===producto.id_producto?'selected':''}>${p.nombre}</option>`).join('')}
      </select>
    </td>
    <td><input type="number" min="1" class="form-control cantidad" value="${producto.cantidad || 1}"></td>
    <td><input type="number" min="0" class="form-control precio" value="${producto.precio_unitario || 0}"></td>
    <td class="subtotal">${(producto.cantidad && producto.precio_unitario ? (producto.cantidad*producto.precio_unitario).toFixed(2) : '0.00')}</td>
    <td><button type="button" class="btn btn-danger btn-sm eliminar">Eliminar</button></td>
  `;
  document.querySelector('#tablaProductos tbody').appendChild(row);

  row.querySelector('.cantidad').addEventListener('input',()=>actualizarSubtotal(row));
  row.querySelector('.precio').addEventListener('input',()=>actualizarSubtotal(row));
  row.querySelector('.producto').addEventListener('change', e=>{
    const id = parseInt(e.target.value);
    const prod = productosDisponibles.find(p=>p.id===id);
    if(prod) row.querySelector('.precio').value = prod.precio;
    actualizarSubtotal(row);
  });
  row.querySelector('.eliminar').addEventListener('click', ()=>{
    row.remove();
    actualizarTotal();
  });

  actualizarSubtotal(row);
}

// --- Eventos ---
document.getElementById('btnAgregarProducto').addEventListener('click', ()=>agregarFila());
document.getElementById('btnGuardar').addEventListener('click', async ()=>{
  const id_usuario = parseInt(document.getElementById('id_usuario').value);
  const productos = [];
  document.querySelectorAll('#tablaProductos tbody tr').forEach(row=>{
    const id_producto = parseInt(row.querySelector('.producto').value);
    const cantidad = parseFloat(row.querySelector('.cantidad').value);
    const precio_unitario = parseFloat(row.querySelector('.precio').value);
    if(id_producto && cantidad && precio_unitario){
      productos.push({id_producto, cantidad, precio_unitario});
    }
  });

  try {
    let res;
    if(ventaEditando){ // PUT
      res = await fetch(`${apiUrl}/${ventaEditando}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({productos})
      });
    } else { // POST
      res = await fetch(apiUrl, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id_usuario, productos})
      });
    }

    const data = await res.json();
    alert(data.message);
    bootstrap.Modal.getInstance(document.getElementById('modalVenta')).hide();
    cargarVentas();
    limpiarModal();
  } catch(err){
    alert("Error: "+err.message);
  }
});

function limpiarModal(){
  document.getElementById('id_usuario').value='';
  document.getElementById('tablaProductos').querySelector('tbody').innerHTML='';
  document.getElementById('total').value='';
  ventaEditando = null;
}

function abrirModalAgregar(){
  limpiarModal();
  document.getElementById('tituloModal').innerText = "Agregar Venta";
  new bootstrap.Modal(document.getElementById('modalVenta')).show();
}

async function abrirModalEditar(id_venta){
  ventaEditando = id_venta;
  document.getElementById('tituloModal').innerText = "Editar Venta";

  const res = await fetch(`${apiUrl}/detalles/${id_venta}`);
  const venta = await res.json();
  document.getElementById('id_usuario').value = venta.usuario_id || '';
  document.querySelector('#tablaProductos tbody').innerHTML='';
  venta.detalles.forEach(d => agregarFila(d));
  actualizarTotal();

  new bootstrap.Modal(document.getElementById('modalVenta')).show();
}

async function eliminarVenta(id_venta){
  if(!confirm("¿Eliminar esta venta?")) return;
  const res = await fetch(`${apiUrl}/${id_venta}`, {method:'DELETE'});
  const data = await res.json();
  alert(data.message);
  cargarVentas();
}

// Cargar ventas
async function cargarVentas(){
  const res = await fetch(apiUrl);
  const ventas = await res.json();
  const tbody = document.querySelector("#tablaVentas tbody");
  tbody.innerHTML="";
  ventas.forEach(v=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${v.id_venta}</td>
      <td>${v.usuario}</td>
      <td>${new Date(v.fecha).toLocaleString()}</td>
      <td>${v.total}</td>
      <td>
        <button class="btn btn-sm btn-info" onclick="abrirModalEditar(${v.id_venta})">Editar</button>
        <button class="btn btn-sm btn-danger" onclick="eliminarVenta(${v.id_venta})">Eliminar</button>
        <button class="btn btn-sm btn-secondary" onclick="verDetalles(${v.id_venta}, this)">Detalles</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Ver detalles (toggle)
async function verDetalles(id_venta, btn){
  const tr = btn.closest("tr");
  if(tr.nextElementSibling && tr.nextElementSibling.classList.contains("detalles")){
    tr.nextElementSibling.remove();
    return;
  }
  const res = await fetch(`${apiUrl}/detalles/${id_venta}`);
  const venta = await res.json();
  const detallesTr = document.createElement('tr');
  detallesTr.classList.add('detalles');
  detallesTr.innerHTML = `
    <td colspan="5">
      <table class="table table-sm table-bordered mb-0">
        <thead>
          <tr>
            <th>Producto</th><th>Cantidad</th><th>Precio Unitario</th><th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
          ${venta.detalles.map(d=>`
            <tr>
              <td>${d.producto}</td>
              <td>${d.cantidad}</td>
              <td>${d.precio_unitario}</td>
              <td>${d.subtotal}</td>
            </tr>`).join('')}
        </tbody>
      </table>
    </td>
  `;
  tr.after(detallesTr);
}

// Inicializar
cargarVentas();
</script>

</body>
</html>
